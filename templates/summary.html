<!DOCTYPE html>
<html>
{% if msg %}
  <div style="padding: 10px; background-color: #e0ffe0; border: 1px solid green; margin-bottom: 20px;">
    {{ msg }}
  </div>
{% endif %}

<head>
    <title>Portfolio Summary</title>
    <style>
  .collapsible {
    background-color: #f1f1f1;
    color: #444;
    cursor: pointer;
    padding: 12px;
    width: 100%;
    text-align: left;
    border: none;
    outline: none;
    font-size: 16px;
    font-weight: bold;
    margin-top: 10px;
  }

  .collapsible.active, .collapsible:hover {
    background-color: #ddd;
  }

  .content {
    padding: 0 18px;
    display: none;
    overflow: hidden;
    margin-bottom: 20px;
  }
</style>
</head>
<body>
    <!-- <div>
    {{ summary_text | safe }}
    </div> -->
{% for asset_type, data in summary_data.items() %}
<details open>
  <summary style="font-weight: bold; font-size: 1.1em;">
    {{ data.display_name }} ({{ data.currency }})
  </summary>
  
  <table border="1" cellpadding="6" cellspacing="0" style="margin-top: 10px; width: 100%;">
    <thead style="background-color: #f0f0f0;">
      <tr>
        <th>Fund</th>
        <th>Latest NAV</th>
        <th>Units</th>
        <th>Invested</th>
        <th>Current</th>
        <th>Realized P/L</th>
        <th>Unrealized P/L</th>
        <th>Avg NAV</th>
        <th>% Return</th>
        <th>% Portfolio</th>
        <th>XIRR</th>
        <th>Min NAV</th>
        <th>Max NAV</th>
      </tr>
    </thead>
    <tbody>
      {% for row in data.rows %}
      <tr>
        <td>{{ row.scheme_name }}</td>
        <td>{{ row.latest_nav }}</td>
        <td>{{ row.net_units }}</td>
        <td>{{ row.invested | format_currency(data.currency) }}</td>
        <td>{{ row.current_value | format_currency(data.currency) }}</td>
        <td>{{ row.realized_pl | format_currency(data.currency) }}</td>
        <td>{{ row.unrealized_pl | format_currency(data.currency) }}</td>
        <td>{{ row.avg_nav }}</td>
        <td>{{ row.pct_change }}</td>
        <td>{{ row.pct_portfolio }}</td>
        <td>{{ row.xirr }}</td>
        <td>{{ row.min_nav }}</td>
        <td>{{ row.max_nav }}</td>
      </tr>
      {% endfor %}

      <!-- Totals Row -->
      <tr style="font-weight: bold; background-color: #e8f5e9;">
        <td>Total</td>
        <td></td>
        <td></td>
        <td>{{ data.totals.invested | format_currency(data.currency) }}</td>
        <td>{{ data.totals.current | format_currency(data.currency) }}</td>
        <td>{{ data.totals.realized | format_currency(data.currency) }}</td>
        <td>{{ data.totals.unrealized | format_currency(data.currency) }}</td>
        <td colspan="6"></td>
      </tr>
    </tbody>
  </table>
</details>

<br>
{% endfor %} 
  <h2>üìä Portfolio Summary</h2>

{% for asset_type, data in summary_data.items() %}
    <div class="asset-section">
        <h3 style="cursor: pointer;" onclick="toggleSection('{{ asset_type }}')">
            ‚ñ∂Ô∏è {{ asset_type.replace('_', ' ').title() }}
        </h3>

        <table border="1" cellpadding="5" cellspacing="0" style="width: 100%;">
            <thead>
                <tr>
                    <th>Fund</th>
                    <th>Latest NAV</th>
                    <th>Units</th>
                    <th>Invested</th>
                    <th>Current</th>
                    <th>Realized P/L</th>
                    <th>Unrealized P/L</th>
                    <th>Avg Purchase NAV</th>
                    <th>% Return</th>
                    <th>% Portfolio</th>
                    <th>XIRR</th>
                    <th>Min NAV</th>
                    <th>Max NAV</th>
                </tr>
            </thead>
            <tbody>
                <!-- Total row (always visible) -->
                <tr style="background-color: #f2f2f2;">
                   {% set fields = ['invested', 'current', 'realized', 'unrealized'] %}
                    <td><strong>Total</strong></td>
                    <td></td>
                    <td></td>
                    {% for field in fields %}
                        <td><strong>{{ data.totals[field] | format_currency(data.currency) }}</strong></td>
                    {% endfor %}
                    <td colspan="6"></td>
                </tr>
                <!-- Individual scheme rows (hidden initially) -->
      
               {% for row in data.rows %}
                <tr class="scheme-row {{ asset_type }}" style="display: none;">
                  <td>{{ row.scheme_name }}</td>
                  <td>{{ row.latest_nav }}</td>
                  <td>{{ row.net_units }}</td>
                  <td>{{ row.invested | format_currency(data.currency) }}</td>
                  <td>{{ row.current_value | format_currency(data.currency) }}</td>
                  <td>{{ row.realized_pl | format_currency(data.currency) }}</td>
                  <td>{{ row.unrealized_pl | format_currency(data.currency) }}</td>
                  <td>{{ row.avg_nav }}</td>
                  <td>{{ row.pct_change }}</td>
                  <td>{{ row.pct_portfolio }}</td>
                  <td>{{ row.xirr }}</td>
                  <td>{{ row.min_nav }}</td>
                  <td>{{ row.max_nav }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <br>
{% endfor %}

<div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
    <form action="{{ url_for('main.upload') }}" method="get">
        <button type="submit">‚¨ÜÔ∏è Upload New Transactions</button>
    </form>

    <p style="font-size: 14px; color: #888; margin: 0;">
        üì¶ Current Storage Backend: <strong>{{ backend_type }}</strong>
    </p>

    <form action="{{ url_for('settings.backend') }}" method="get">
        <button type="submit">‚öôÔ∏è Switch Backend</button>
    </form>
{% if session.get('user') %}
    <p>
        Logged in as <strong>{{ session.get('user') }}</strong>
        | <a href="{{ url_for('auth.logout') }}">Logout</a>
    </p>
{% else %}
     <p>
        <a href="{{ url_for('auth.login') }}">Login</a>
    </p>
{% endif %}

</div>

    <hr>

    <h3>üìÑ Existing Transactions</h3>
<table border="1" cellpadding="5" cellspacing="0">
    <thead>
        <tr>
            {% for col in transaction_header %}
                <th>{{ col }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for row in transaction_data %}
            <tr>
                {% for cell in row %}
                    <td>{{ cell }}</td>
                {% endfor %}
            </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination Controls -->
<div style="margin-top: 20px;">
    {% if page > 1 %}
        <a href="{{ url_for('main.summary', page=page-1) }}">‚¨ÖÔ∏è Previous</a>
    {% endif %}
    
    <span>Page {{ page }} of {{ total_pages }}</span>

    {% if page < total_pages %}
        <a href="{{ url_for('main.summary', page=page+1) }}">Next ‚û°Ô∏è</a>
    {% endif %}
</div>
  <script>
  document.addEventListener("DOMContentLoaded", function() {
    const collapsibles = document.querySelectorAll(".collapsible");
    collapsibles.forEach(button => {
      button.addEventListener("click", function() {
        this.classList.toggle("active");
        const content = this.nextElementSibling;
        if (content.style.display === "block") {
          content.style.display = "none";
        } else {
          content.style.display = "block";
        }
      });
    });
  });
</script>
  <script>
function toggleSection(assetType) {
    const rows = document.querySelectorAll(`.scheme-row.${assetType}`);
    const anyVisible = Array.from(rows).some(row => row.style.display !== "none");

    rows.forEach(row => {
        row.style.display = anyVisible ? "none" : "table-row";
    });
}
</script>
</body>
</html>
